---
title: 3D Visualisation Kasus Covid-19 Perkelurahan di Surabaya 2
author: idrusfachr
date: '2020-06-06'
slug: 3d-visualisation-kasus-covid-19-perkelurahan-di-surabaya-2
categories:
  - R
tags:
  - R
  - rayshader
  - map
lastmod: '2020-06-18T00:32:33+07:00'
description: '3D map visualsation di R menggunakan rayshader package'
show_in_homepage: yes
show_description: no
license: ''
featured_image: ''
featured_image_preview: ''
comment: yes
toc: no
autoCollapseToc: yes
math: no
---


<div id="TOC">
no
</div>

<div id="intro" class="section level2">
<h2>Intro</h2>
<p>Jadi kali ini saya ingin mencoba package <code>rayshader</code> untuk 3D visualisation, berhubung kasus Covid-19 di Surabaya saat ini sangat mengkhawatirkan (zona hitam) per hari ini, maka saya coba kasus Covid-19 di Surabaya ini sebagai use case, mungkin ada manfaat yang bisa didapat nanti.</p>
<p><code>rayshader</code> sendiri fungsi utamanya adalah membuat 3D graph terutama untuk map, topografi, kontur, render satelit dan bisa juga untuk men-translate atau membuat efek 3D pada grafik <code>ggplot</code> seperti yang akan saya coba kali ini.</p>
</div>
<div id="workflow" class="section level2">
<h2>Workflow</h2>
<ul>
<li>Download data, download data shp Indonesia hingga level 4 (kelurahan/desa) dan data jumlah kasus terkonfirmasi covid di Surabaya level kelurahan.</li>
<li>Preprocess data .shp dengan data Covid-19 Surabaya</li>
<li>Membuat 2D map dengan <code>ggplot2</code> sebagai background untuk 3D graph</li>
<li>Membuat grafik 3D dengan <code>rayshader</code></li>
</ul>
</div>
<div id="download-data" class="section level2">
<h2>Download Data</h2>
<p>Data shapefile atau shp Indonesia bisa didownload di <a href="https://gadm.org/download_country_v2.html">website GADM</a>, download hingga level 4 (kelurahan/desa). Untuk data kasus Covid-19 Surabaya busa dilihat di <a href="https://lawancovid-19.surabaya.go.id/">website resmi pemkot</a>.</p>
</div>
<div id="preprocess-data" class="section level2">
<h2>Preprocess data</h2>
<p>Tahap ini agak tricky karena nama kelurahan yang terdaftar di shapefile data penulisannya beda dengan di website Covid-19 Surabaya misal <code>Pacarkembang</code> dan <code>Pacar Kembang</code>, padahal nama kelurahan ini akan digunakan untuk join id 2 data tersebut sehingga harus identik. Akhirnya, terpaksa menyamanakan penulisan nama kelurahan di data Covid-19 Surabaya dengan penulisan di shapefile secara <em>manual</em>.</p>
<p>Steps :</p>
<ul>
<li>Import .rds (shapefile) level 4 data ke dalam R
<ul>
<li>Filter ambil kota Surabaya saja</li>
<li>Buat data frame berisi ID dan nama kelurahan dara data .rds yang sudah diimport</li>
</ul></li>
<li>Mencari centroid data dari tiap-tiap kelurahan</li>
<li>Import data kasus covid Surabaya (yang sudah diedit manual penamaan nama Kelurahannya)</li>
<li>Merge data .rds dan kasus covid-19
<ul>
<li>Ubah .rds yang sudah diimport menjadi data frame dengan <code>fortify</code></li>
<li>Merge data frame yang sudah didapat dengan data ID dan nama kelurahan di step 1</li>
<li>Merge data map dengan data kasus covid Surabaya (border dan centroid)</li>
<li>Replace <code>NA</code> dengan 0</li>
</ul></li>
</ul>
<div id="import-data" class="section level3">
<h3>Import Data</h3>
<pre class="r"><code>#import .rds data
library(sp)
idn_map = readRDS(&quot;/YOUR_PATH/IDN_4_sp.rds&quot;)
#filter Surabaya area only
idn_map &lt;- idn_map[idn_map$NAME_2 == &quot;Surabaya&quot;,] 
#create data frame of ID and Kelurahan name
idn_map_dict &lt;- data.frame(id=sapply(slot(idn_map, &quot;polygons&quot;), function(x) slot(x, &quot;ID&quot;)), 
                           Kelurahan=idn_map$NAME_4)
head(idn_map_dict)</code></pre>
</div>
<div id="get-centroid" class="section level3">
<h3>Get Centroid</h3>
<p>Ini tahap yang critical dalam membuat visualisasi 3D. kegunaan centroid point adalah untuk 3D bar akan berada nantinya. Data shapefile adalah data batas-batas antar wilayah, sehingga titik-titiknya berada di setiap batas wilayah (border), sedangkan centroid adalah titik tengah dari wilayah tersebut. Data centroid sudah tersedia saat kita import .rds file. Cara mendapatkannya adalah:</p>
<pre class="r"><code>library(rgeos)
library(dplyr)
centroid &lt;- SpatialPointsDataFrame(gCentroid(idn_map, byid=TRUE), 
                                      idn_map@data, match.ID=FALSE)
centroid_df &lt;- data.frame(centroid)
centroid_df &lt;- data.frame(Kelurahan=centroid_df$NAME_4, lat=centroid_df$x, long=centroid_df$y)
centroid_id_map &lt;- left_join(centroid_df, idn_map_dict, by=&quot;Kelurahan&quot;)
centroid_id_map$Kelurahan &lt;- as.character(centroid_id_map$Kelurahan)
head(centroid_id_map)</code></pre>
<pre><code>##       Kelurahan      lat      long     id
## 1      Asemrowo 112.7038 -7.244670 320532
## 2       Genting 112.7085 -7.238667 320531
## 3        Greges 112.6850 -7.239921 320411
## 4      Kalianak 112.6969 -7.227247 320417
## 5 Tambak Langon 112.6694 -7.230947 320407
## 6     Kandangan 112.6507 -7.246314 320560</code></pre>
</div>
<div id="import-data-kasus-covid-19-surabaya" class="section level3">
<h3>Import data kasus Covid-19 Surabaya</h3>
<pre class="r"><code>#import data covid-19 cases at Surabaya
covid_sby &lt;- read.csv(&#39;/YOUR_PATH/covid_sby.csv&#39;)
covid_sby &lt;- covid_sby[,c(&quot;Kelurahan&quot;,&quot;KUMULATIF.KONFIRMASI&quot;)]
covid_sby$Kelurahan &lt;- gsub(&quot;Kelurahan &quot;, &quot;&quot;, covid_sby$Kelurahan)
head(covid_sby)</code></pre>
</div>
<div id="merge-data" class="section level3">
<h3>Merge data</h3>
<p>Ubah <code>idn_map</code> menjadi data frame dengan function <code>fortify</code> dari <code>ggplot2</code>. Merge dengan <code>idn_map_dict</code> yang dibuat di step 1. Guananya untuk menambahkan nama kelurahan ke data hasil <code>fortify</code>-ing.</p>
<pre class="r"><code>library(ggplot2)
idn_map_df &lt;- fortify(idn_map)
idn_map_df &lt;- merge(idn_map_df,idn_map_dict, by = &quot;id&quot;)
idn_map_df$Kelurahan &lt;- as.character(idn_map_df$Kelurahan)
head(idn_map_df)</code></pre>
<pre><code>##       id     long       lat order  hole piece    group    Kelurahan
## 1 320022 112.6267 -7.219698     1 FALSE     1 320022.1 Romokalisari
## 2 320022 112.6268 -7.219243     2 FALSE     1 320022.1 Romokalisari
## 3 320022 112.6269 -7.218642     3 FALSE     1 320022.1 Romokalisari
## 4 320022 112.6270 -7.218376     4 FALSE     1 320022.1 Romokalisari
## 5 320022 112.6270 -7.218278     5 FALSE     1 320022.1 Romokalisari
## 6 320022 112.6271 -7.218069     6 FALSE     1 320022.1 Romokalisari</code></pre>
<p>Merge data map dengan data covid_sby (border map)</p>
<pre class="r"><code>library(dplyr)
map_data &lt;- left_join(idn_map_df, covid_sby, by = &quot;Kelurahan&quot;)
map_data[is.na(map_data)] &lt;- 0</code></pre>
<p>Merge data centroid dengan data covid_sby (centroid map)</p>
<pre class="r"><code>centroid_map_data &lt;- inner_join(centroid_id_map, covid_sby, by = &quot;Kelurahan&quot;)
centroid_map_data[is.na(centroid_map_data)] &lt;- 0</code></pre>
</div>
</div>
<div id="membuat-2d-map" class="section level2">
<h2>Membuat 2D Map</h2>
<p>Membuat 2D map dengan 1ggplot2` yang akan digunakan sebagai background dari 3D map.</p>
<pre class="r"><code>library(ggplot2)
# Map
map_bg = ggplot(map_data, aes(long, lat, group=group, fill = KUMULATIF.KONFIRMASI)) +
  geom_polygon() + # Shape
  scale_fill_gradient(limits=range(map_data$KUMULATIF.KONFIRMASI), 
                      low=&quot;#FFF3B0&quot;, high=&quot;#E09F3E&quot;) + 
  layer(geom=&quot;path&quot;, stat=&quot;identity&quot;, position=&quot;identity&quot;, 
       mapping=aes(x=long, y=lat, group=group, 
                   color=I(&#39;#FFFFFF&#39;))) + 
  theme(legend.position = &quot;none&quot;, 
        axis.line=element_blank(), 
        axis.text.x=element_blank(), axis.title.x=element_blank(),
        axis.text.y=element_blank(), axis.title.y=element_blank(),
        axis.ticks=element_blank(), 
        panel.background = element_blank()) # Clean Everything
map_bg</code></pre>
<p><img src="/posts/2020-06-06-3d-visualisation-kasus-covid-19-perkelurahan-di-surabaya_files/figure-html/unnamed-chunk-9-1.png" width="672" /></p>
<p>Save map as PNG</p>
<pre class="r"><code># 2D Plot
library(grid)
library(png)
sby_map_bg &lt;- readPNG(&#39;map_2D.png&#39;)
covid_sby_map = ggplot(centroid_map_data) + 
  annotation_custom(rasterGrob(sby_map_bg, width=unit(1,&quot;npc&quot;), 
                               height=unit(1,&quot;npc&quot;)), 
                    -Inf, Inf, -Inf, Inf) + 
  xlim(xlim[1],xlim[2]) + # x-axis Mapping
  ylim(ylim[1],ylim[2]) + # y-axis Mapping
  geom_point(aes(x=lat, y=long, color=KUMULATIF.KONFIRMASI),size=2) + 
  scale_colour_gradient(name = &#39;Confirmed Cases&#39;, 
                        limits=range(centroid_map_data$KUMULATIF.KONFIRMASI), 
                        low=&quot;#FCB9B2&quot;, high=&quot;#B23A48&quot;) +
  ggtitle(&quot;Kasus Covid-19 Perkelurahan di Surabaya per 6 Juni 2020&quot;) +
  labs(caption = &quot;Source data : lawancovid-19.surabaya.go.id \nGraph by : idrusfachr.netlify.com&quot;) +
  theme(axis.line=element_blank(), 
        axis.text.x=element_blank(), axis.title.x=element_blank(),
        axis.text.y=element_blank(), axis.title.y=element_blank(),
        axis.ticks=element_blank(), 
        panel.background = element_blank()) # Clean Everything
covid_sby_map</code></pre>
<p><img src="/posts/2020-06-06-3d-visualisation-kasus-covid-19-perkelurahan-di-surabaya_files/figure-html/unnamed-chunk-11-1.png" width="672" /></p>
<p>Kegunaan data centroid yang dibuat sebelumnya adalah untuk menampilkan point merah seperti di map diatas.</p>
</div>
<div id="membuat-3d-map" class="section level2">
<h2>Membuat 3D map</h2>
<pre class="r"><code># 3D Plot
library(rayshader)
par(mfrow = c(1, 2))
plot_gg(covid_sby_map, multicore = TRUE, width=5,height=7,raytrace=FALSE,preview = TRUE) 

plot_gg(covid_sby_map, multicore = TRUE, width=5,height=7,scale=300,windowsize=c(1600,1000),
       zoom = 0.55, phi = 30) 

Sys.sleep(0.2)
render_snapshot(clear = TRUE)</code></pre>
<p><img src="/posts/2020-06-06-3d-visualisation-kasus-covid-19-perkelurahan-di-surabaya_files/figure-html/unnamed-chunk-12-1.png" width="672" /></p>
<p>Render Video</p>
<pre class="r"><code>library(rgl)
par3d(windowRect = c(0, 0, diff(xlim) * 2500, diff(ylim) * 2500))

# Render Image
#render_camera(fov = 70, zoom = 0.2, theta = 30, phi = 20)
#render_depth(focus = 0.8, focallength = 600)

# Render Video
phivechalf = 30 + 60 * 1/(1 + exp(seq(-7, 20, length.out = 180)/2))
phivecfull = c(phivechalf, rev(phivechalf))
thetavec = 0 + 45 * sin(seq(0,359,length.out = 360) * pi/180)
zoomvec = 0.45 + 0.2 * 1/(1 + exp(seq(-5, 20, length.out = 180)))
zoomvecfull = c(zoomvec, rev(zoomvec))
render_movie(filename = &#39;map_video&#39;, type = &quot;custom&quot;, frames = 360,  phi = phivecfull, zoom = zoomvecfull, theta = thetavec)

rgl.close()</code></pre>
<p><embed src="/images/map_video.mp4" /></p>
<p>Refferences :
- <a href="https://www.rayshader.com/index.html" class="uri">https://www.rayshader.com/index.html</a>
- <a href="https://towardsdatascience.com/introducing-3d-ggplots-with-rayshader-r-c61e27c6f0e9" class="uri">https://towardsdatascience.com/introducing-3d-ggplots-with-rayshader-r-c61e27c6f0e9</a></p>
</div>
